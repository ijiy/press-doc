import{_ as s,c as a,o as n,a1 as l}from"./chunks/framework.B3EJgH_4.js";const y=JSON.parse('{"title":"微信小程序 - 云函数","description":"","frontmatter":{},"headers":[],"relativePath":"uniapp/kf-wx/wxcloud.md","filePath":"uniapp/kf-wx/wxcloud.md","lastUpdated":1725247280000}'),e={name:"uniapp/kf-wx/wxcloud.md"},p=l(`<h1 id="微信小程序-云函数" tabindex="-1">微信小程序 - 云函数 <a class="header-anchor" href="#微信小程序-云函数" aria-label="Permalink to &quot;微信小程序 - 云函数&quot;">​</a></h1><h2 id="开发者工具" tabindex="-1">开发者工具 <a class="header-anchor" href="#开发者工具" aria-label="Permalink to &quot;开发者工具&quot;">​</a></h2><ul><li><p>工具 -&gt; 工具栏管理 -&gt; 隐藏 <code>版本管理</code></p></li><li><p>编辑器</p><ul><li>右键 <code>cloudfunction</code> 当前环境: 选择一个环境才能进行上传云函数</li><li>上传并部署: 所有文件 <ul><li>第一次部署或云端不存在所需依赖</li></ul></li><li>上传并部署: 云端安装依赖 <ul><li>云端已存在依赖 (在其它已上传的文件中包含所需依赖)</li></ul></li><li>开启云函数本地调试 <ul><li>需要先 <code>上传并部署</code></li><li>若不存在 node_modules, 需要初始化 (调试过程选择初始化, 或 终端 执行 <code>npm i</code>)</li></ul></li></ul></li></ul><h2 id="云开发控制台" tabindex="-1">云开发控制台 <a class="header-anchor" href="#云开发控制台" aria-label="Permalink to &quot;云开发控制台&quot;">​</a></h2><ul><li><p>概述 =&gt; 设置</p><ul><li>环境名称, 创建新环境 (谨慎取名, 总共只能修改4次) <ul><li>test 测试环境, release 正式环境</li></ul></li></ul></li><li><p>数据库</p><ul><li>创建集合 <ul><li>都要提前准备集合, 否则请求出错</li><li>点赞, 评论, 助力等, 都要和用户挂钩</li></ul></li><li>索引管理 <ul><li>删除不必要的 x_openid_index_</li></ul></li></ul></li></ul><h2 id="事务" tabindex="-1">事务 <a class="header-anchor" href="#事务" aria-label="Permalink to &quot;事务&quot;">​</a></h2><ul><li>缺点 <ul><li>update, set, remove, 都属于 <code>doc(_id)</code> 当记录操作, 不能用 where 批量处理</li><li>批量 get, 图片的操作, 不能使用事务处理</li><li>尽量避免一个函数使用事务处理, 多了个 await, 必然延迟请求</li><li>若没有更改数据库操作, 比如查询, 那么 <code>rollback()</code> 是不会被 catch 捕获, 结果将只有 requestId <ul><li><code>get()</code> 要有 throwOnNotFound, 否则无法被 catch 捕获</li></ul></li></ul></li></ul><h2 id="数据库" tabindex="-1">数据库 <a class="header-anchor" href="#数据库" aria-label="Permalink to &quot;数据库&quot;">​</a></h2><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> taskPhotoAdd </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#F8F8F2;"> transaction.</span><span style="color:#A6E22E;">collection</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;album&#39;</span><span style="color:#F8F8F2;">).</span><span style="color:#A6E22E;">doc</span><span style="color:#F8F8F2;">(albumId).</span><span style="color:#A6E22E;">update</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">	data: {</span></span>
<span class="line"><span style="color:#F8F8F2;">		photos: db.command.</span><span style="color:#A6E22E;">addToSet</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">			$each: [</span><span style="color:#E6DB74;">&#39;插入数组&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;不插入updated返回0&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;已存在不插入&#39;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">		}),</span></span>
<span class="line"><span style="color:#F8F8F2;">	},</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">db.command.</span><span style="color:#A6E22E;">addToSet</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;插入单个&#39;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">taskPhotoAdd.stats.updated</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> colList.</span><span style="color:#A6E22E;">where</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">	_id: dc.</span><span style="color:#A6E22E;">in</span><span style="color:#F8F8F2;">([</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">]),</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">where</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">	_ids: </span><span style="color:#E6DB74;">&#39;包含&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div>`,9),o=[p];function c(t,i,r,F,d,u){return n(),a("div",null,o)}const m=s(e,[["render",c]]);export{y as __pageData,m as default};
